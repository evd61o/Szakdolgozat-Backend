const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');
const mysql = require('mysql')
const bcrypt = require('bcrypt');

const app = express();

app.use(cors());
app.use(bodyParser.json());

const db = mysql.createConnection({
    host:'localhost',
    user:'root',
    password:'',
    database:'database',
    port:3306
});


const port = process.env.PORT || 3000;

app.listen(port, ()=>{console.log(`Szerver fut a ${port} porton`)});

db.connect(err => {
    if(err){console.log('err')}
    console.log('AdatbÃ¡zis sikeresen csatlakoztatva')
});


app.get('/fagyasztok', function (req, res, next) {
    db.query(
        'SELECT fagyasztok.*, markak.Marka FROM fagyasztok INNER JOIN markak ON fagyasztok.BrandID = markak.BrandID;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/fagyasztok/min', function (req, res, next) {
    db.query(
        'SELECT fagyasztok.*, markak.Marka FROM fagyasztok INNER JOIN markak ON fagyasztok.BrandID = markak.BrandID WHERE fagyasztok.Fogyasztasev = (SELECT MIN(Fogyasztasev) FROM fagyasztok) LIMIT 1;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/fagyasztok/:selected_freezer_y_c', function (req, res, next) {
    var adr = req.params.selected_freezer_y_c;
    var sql = 'SELECT fagyasztok.*, markak.Marka FROM fagyasztok INNER JOIN markak ON fagyasztok.BrandID = markak.BrandID WHERE fagyasztok.Fogyasztasev < ?';
    db.query(sql, [adr], function (error, results) {
        if (error) {
            console.log(error);
            res.status(500).json({status: 'error'});
        } else {
            res.status(200).json(results);
        }
    });
});

app.get('/fozolapok', function (req, res, next) {
    db.query(
        'SELECT fozolapok.*, markak.Marka FROM fozolapok INNER JOIN markak ON fozolapok.BrandID = markak.BrandID;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/fozolapok/min', function (req, res, next) {
    db.query(
        'SELECT fozolapok.*, markak.Marka FROM fozolapok INNER JOIN markak ON fozolapok.BrandID = markak.BrandID WHERE fozolapok.Fogyasztas = (SELECT MIN(Fogyasztas) FROM fozolapok) LIMIT 1;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/fozolapok/:selected_hot_plate_c', function (req, res, next) {
    var adr = req.params.selected_hot_plate_c;
    var sql = 'SELECT fozolapok.*, markak.Marka FROM fozolapok INNER JOIN markak ON fozolapok.BrandID = markak.BrandID WHERE fozolapok.Fogyasztas < ?;'
    db.query(sql, [adr], function (error, results) {
        if (error) {
            console.log(error);
            res.status(500).json({status: 'error'});
        } else {
            res.status(200).json(results);
        }
    });
});

app.get('/hutok', function (req, res, next) {
    db.query(
        'SELECT hutok.*, markak.Marka FROM hutok INNER JOIN markak ON hutok.BrandID = markak.BrandID;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/hutok/min', function (req, res, next) {
    db.query(
        'SELECT hutok.*, markak.Marka FROM hutok INNER JOIN markak ON hutok.BrandID = markak.BrandID WHERE hutok.Fogyasztasev = (SELECT MIN(Fogyasztasev) FROM hutok) LIMIT 1;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/hutok/:selected_refrigerator_y_c', function (req, res, next) {
    var adr = req.params.selected_refrigerator_y_c;
    var sql = 'SELECT hutok.*, markak.Marka FROM hutok INNER JOIN markak ON hutok.BrandID = markak.BrandID WHERE hutok.Fogyasztasev < ?';
    db.query(sql, [adr], function (error, results) {
        if (error) {
            console.log(error);
            res.status(500).json({status: 'error'});
        } else {
            res.status(200).json(results);
        }
    });
});

app.get('/mikrohullamu_sutok', function (req, res, next) {
    db.query(
        'SELECT mikrohullamu_sutok.*, markak.Marka FROM mikrohullamu_sutok INNER JOIN markak ON mikrohullamu_sutok.BrandID = markak.BrandID;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/mikrohullamu_sutok/min', function (req, res, next) {
    db.query(
        'SELECT mikrohullamu_sutok.*, markak.Marka FROM mikrohullamu_sutok INNER JOIN markak ON mikrohullamu_sutok.BrandID = markak.BrandID WHERE mikrohullamu_sutok.Fogyasztas = (SELECT MIN(Fogyasztas) FROM mikrohullamu_sutok) LIMIT 1;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/mosogatogepek', function (req, res, next) {
    db.query(
        'SELECT mosogatogepek.*, markak.Marka FROM mosogatogepek INNER JOIN markak ON mosogatogepek.BrandID = markak.BrandID;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/mosogatogepek/min', function (req, res, next) {
    db.query(
        'SELECT mosogatogepek.*, markak.Marka FROM mosogatogepek INNER JOIN markak ON mosogatogepek.BrandID = markak.BrandID WHERE mosogatogepek.Fogyasztas_kWh_eco_program = (SELECT MIN(Fogyasztas_kWh_eco_program) FROM mosogatogepek) LIMIT 1;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/mosogatogepek/:selected_dishwasher_ep_c', function (req, res, next) {
    var adr = req.params.selected_dishwasher_ep_c;
    var sql = 'SELECT mosogatogepek.*, markak.Marka FROM mosogatogepek INNER JOIN markak ON mosogatogepek.BrandID = markak.BrandID WHERE mosogatogepek.Fogyasztas_kWh_eco_program < ?';
    db.query(sql, [adr], function (error, results) {
        if (error) {
            console.log(error);
            res.status(500).json({status: 'error'});
        } else {
            res.status(200).json(results);
        }
    });
});

app.get('/paraelszivok', function (req, res, next) {
    db.query(
        'SELECT paraelszivok.*, markak.Marka FROM paraelszivok INNER JOIN markak ON paraelszivok.BrandID = markak.BrandID;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/paraelszivok/min', function (req, res, next) {
    db.query(
        'SELECT paraelszivok.*, markak.Marka FROM paraelszivok INNER JOIN markak ON paraelszivok.BrandID = markak.BrandID WHERE paraelszivok.Fogyasztas = (SELECT MIN(Fogyasztas) FROM paraelszivok) LIMIT 1;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/sutok', function (req, res, next) {
    db.query(
        'SELECT sutok.*, markak.Marka FROM sutok INNER JOIN markak ON sutok.BrandID = markak.BrandID;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/sutok/minhagyomanyos', function (req, res, next) {
    db.query(
        'SELECT sutok.*, markak.Marka FROM sutok INNER JOIN markak ON sutok.BrandID = markak.BrandID WHERE sutok.Egy_uzemciklusra_vetitett_energiafogyasztas_hagyomanyos = (SELECT MIN(Egy_uzemciklusra_vetitett_energiafogyasztas_hagyomanyos) FROM sutok) LIMIT 1;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/sutok/minlegkevereses', function (req, res, next) {
    db.query(
        'SELECT sutok.*, markak.Marka FROM sutok INNER JOIN markak ON sutok.BrandID = markak.BrandID WHERE sutok.Egy_uzemciklusra_vetitett_energiafogyasztas_legkevereses = (SELECT MIN(Egy_uzemciklusra_vetitett_energiafogyasztas_legkevereses) FROM sutok) LIMIT 1;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/sutok/:selected_oven_c_traditional/:selected_oven_c_airmixing', function (req, res, next) {
    var adrTraditional = req.params.selected_oven_c_traditional;
    var adrAirmixing = req.params.selected_oven_c_airmixing;
    var sql = 'SELECT sutok.*, markak.Marka FROM sutok INNER JOIN markak ON sutok.BrandID = markak.BrandID WHERE sutok.Egy_uzemciklusra_vetitett_energiafogyasztas_hagyomanyos < ? and sutok.Egy_uzemciklusra_vetitett_energiafogyasztas_legkevereses < ?;';
    db.query(sql, [adrTraditional, adrAirmixing], function (error, results) {
        if (error) {
            console.log(error);
            res.status(500).json({status: 'error'});
        } else {
            res.status(200).json(results);
        }
    });
});

app.get('/mosogepek', function (req, res, next) {
    db.query(
        'SELECT mosogepek.*, markak.Marka FROM mosogepek INNER JOIN markak ON mosogepek.BrandID = markak.BrandID;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/mosogepek/min', function (req, res, next) {
    db.query(
        'SELECT mosogepek.*, markak.Marka FROM mosogepek INNER JOIN markak ON mosogepek.BrandID = markak.BrandID WHERE mosogepek.Fogyasztas_eco_40_60_program = (SELECT MIN(Fogyasztas_eco_40_60_program) FROM mosogepek) LIMIT 1;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/mosogepek/:selected_washing_m_ep40_60_c', function (req, res, next) {
    var adr = req.params.selected_washing_m_ep40_60_c;
    var sql = 'SELECT mosogepek.*, markak.Marka FROM mosogepek INNER JOIN markak ON mosogepek.BrandID = markak.BrandID WHERE mosogepek.Fogyasztas_eco_40_60_program < ?';
    db.query(sql, [adr], function (error, results) {
        if (error) {
            console.log(error);
            res.status(500).json({status: 'error'});
        } else {
            res.status(200).json(results);
        }
    });
});

app.get('/szaritogepek', function (req, res, next) {
    db.query(
        'SELECT szaritogepek.*, markak.Marka FROM szaritogepek INNER JOIN markak ON szaritogepek.BrandID = markak.BrandID;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});

app.get('/szaritogepek/min', function (req, res, next) {
    db.query(
        'SELECT szaritogepek.*, markak.Marka FROM szaritogepek INNER JOIN markak ON szaritogepek.BrandID = markak.BrandID WHERE szaritogepek.Fogyasztasev = (SELECT MIN(Fogyasztasev) FROM szaritogepek) LIMIT 1;',
        (error, results) => {
            if (error) {
                console.log(error);
                res.status(500).json({status: 'error'});
            } else {
                res.status(200).json(results);
            }
        }
    );
});


app.get('/szaritogepek/:selected_dryer_y_c', function (req, res, next) {
    var adr = req.params.selected_dryer_y_c;
    var sql = 'SELECT szaritogepek.*, markak.Marka FROM szaritogepek INNER JOIN markak ON szaritogepek.BrandID = markak.BrandID WHERE szaritogepek.Fogyasztasev < ?;';
    db.query(sql, [adr], function (error, results) {
        if (error) {
            console.log(error);
            res.status(500).json({status: 'error'});
        } else {
            res.status(200).json(results);
        }
    });

});

app.post('/users', async (req, res) => {
    const { username, email, password, action } = req.body;
    const plainPassword = req.body.password; // FelhasznÃ¡lÃ³ Ã¡ltal megadott jelszÃ³

    if (action === 'login') {
        // EllenÅrizd az email cÃ­met az adatbÃ¡zisban
        const loginQuery = 'SELECT * FROM users WHERE email = ?';
        db.query(loginQuery, [email], (err, results) => {
            if (err) {
                console.error('Hiba az adatbÃ¡zis lekÃ©rdezÃ©sekor: ' + err.stack);
                res.status(500).json({ error: 'Hiba tÃ¶rtÃ©nt a bejelentkezÃ©s sorÃ¡n' });
                return;
            }

            if (results.length === 1) {
                const storedHashedPassword = results[0].password;

                // Itt hasznÃ¡lhatod a bcrypt.compare-t a jelszÃ³ ellenÅrzÃ©sÃ©re
                bcrypt.compare(plainPassword, storedHashedPassword, (compareErr, compareResult) =>{
                    if (compareErr) {
                        console.error('Hiba a jelszÃ³ ellenÅrzÃ©sekor: ' + compareErr.stack);
                        res.status(500).json({ error: 'Hiba tÃ¶rtÃ©nt a bejelentkezÃ©s sorÃ¡n' });
                        return;
                    }

                    if (compareResult) {
                        // Sikeres bejelentkezÃ©s
                        res.json({ message: 'Sikeres bejelentkezÃ©s' });
                    } else {
                        // Sikertelen bejelentkezÃ©s, kÃ¼ldj vissza egy hibaÃ¼zenetet
                        res.status(401).json({ error: 'Sikertelen bejelentkezÃ©s' });
                    }
                });
            } else {
                // A megadott email cÃ­mhez nem tartozik felhasznÃ¡lÃ³
                res.status(401).json({ error: 'Sikertelen bejelentkezÃ©s' });
            }
        });
    } else if (action === 'register') {
        const saltRounds = 10; // A titkosÃ­tÃ¡si erÅssÃ©g (10-12 ajÃ¡nlott)
        bcrypt.hash(plainPassword, saltRounds, (err, hashedPassword) => {
            if (err) {
                // Kezeld a hibÃ¡t
            } else {
                // SQL lekÃ©rdezÃ©s az adatbÃ¡zisban lÃ©vÅ felhasznÃ¡lÃ³nÃ©v ellenÅrzÃ©sÃ©hez
                const checkUsernameQuery = 'SELECT * FROM users WHERE username = ?';
                db.query(checkUsernameQuery, [username], (usernameError, usernameResults) => {
                    if (usernameError) {
                        console.error('FelhasznÃ¡lÃ³nÃ©v ellenÅrzÃ©s hiba: ', usernameError);
                        res.status(500).json({message: 'Hiba tÃ¶rtÃ©nt a regisztrÃ¡ciÃ³ sorÃ¡n'});
                    } else {
                        // EllenÅrizzÃ¼k, hogy a felhasznÃ¡lÃ³nÃ©v mÃ¡r lÃ©tezik-e az eredmÃ©nyekben
                        if (usernameResults.length > 0) {
                            console.log('FelhasznÃ¡lÃ³nÃ©v mÃ¡r lÃ©tezik');
                            res.status(409).json({message: 'Ez a felhasznÃ¡lÃ³nÃ©v mÃ¡r foglalt'});
                        } else {
                            // EllenÅrizzÃ¼k az e-mail cÃ­met is
                            const checkEmailQuery = 'SELECT * FROM users WHERE email = ?';
                            db.query(checkEmailQuery, [email], (emailError, emailResults) => {
                                if (emailError) {
                                    console.error('E-mail ellenÅrzÃ©s hiba: ', emailError);
                                    res.status(500).json({message: 'Hiba tÃ¶rtÃ©nt a regisztrÃ¡ciÃ³ sorÃ¡n'});
                                } else {
                                    // EllenÅrizzÃ¼k, hogy az e-mail cÃ­m mÃ¡r lÃ©tezik-e az eredmÃ©nyekben
                                    if (emailResults.length > 0) {
                                        console.log('E-mail cÃ­m mÃ¡r lÃ©tezik');
                                        res.status(410).json({message: 'Ez az e-mail cÃ­m mÃ¡r foglalt'});
                                    } else {
                                        // Ha minden ellenÅrzÃ©s sikeres, akkor elvÃ©gezzÃ¼k a beszÃºrÃ¡st
                                        const insertQuery = 'INSERT INTO users (username, email, password) VALUES (?, ?, ?)';
                                        db.query(insertQuery, [username, email, hashedPassword], (insertError, insertResult) => {
                                            if (insertError) {
                                                console.error('Hiba az adatbÃ¡zisba valÃ³ beszÃºrÃ¡s sorÃ¡n: ', insertError);
                                                res.status(500).json({message: 'Hiba tÃ¶rtÃ©nt a regisztrÃ¡ciÃ³ sorÃ¡n'});
                                            } else {
                                                console.log('Sikeres regisztrÃ¡ciÃ³');
                                                res.status(200).json({message: 'Sikeres regisztrÃ¡ciÃ³'});
                                            }
                                        });
                                    }
                                }
                            });
                        }
                    }
                });
            }
        });
    } else {
        // Ismeretlen mÅ±velet, kÃ¼ldj vissza hibaÃ¼zenetet
        res.status(400).json({ message: 'ÃrvÃ©nytelen mÅ±velet' });
    }
});


app.post('/profiles', (req, res) => {
    const {
        searchValueRefrigerator, searchValueFreezer, searchValueHot_plate, searchValueMicrowave, searchValueDishwasher,
        searchValueDehumidifier, searchValueOven, searchValueWashing_machine, searchValueDryer, email
    } = req.body;

    // EllenÅrizzÃ¼k, hogy az e-mail cÃ­m mÃ¡r lÃ©tezik-e az adatbÃ¡zisban
    const checkEmailQuery = 'SELECT * FROM profiles WHERE email = ?';
    db.query(checkEmailQuery, [email], (emailError, emailResults) => {
        if (emailError) {
            console.error('E-mail cÃ­m ellenÅrzÃ©s hiba: ', emailError);
            res.status(500).json({ message: 'Hiba tÃ¶rtÃ©nt a mentÃ©s sorÃ¡n' });
        } else {
            if (emailResults.length > 0) {
                // Az e-mail cÃ­m mÃ¡r lÃ©tezik, frissÃ­tjÃ¼k a meglÃ©vÅ profilt
                const updateQuery = `
                    UPDATE profiles
                    SET
                        searchValueRefrigerator = ?,
                        searchValueFreezer = ?,
                        searchValueHot_plate = ?,
                        searchValueMicrowave = ?,
                        searchValueDishwasher = ?,
                        searchValueDehumidifier = ?,
                        searchValueOven = ?,
                        searchValueWashing_machine = ?,
                        searchValueDryer = ?
                    WHERE email = ?;
                `;
                const updateValues = [
                    searchValueRefrigerator, searchValueFreezer, searchValueHot_plate, searchValueMicrowave, searchValueDishwasher,
                    searchValueDehumidifier, searchValueOven, searchValueWashing_machine, searchValueDryer, email
                ];
                db.query(updateQuery, updateValues, (updateError, updateResult) => {
                    if (updateError) {
                        console.error('Hiba a profil frissÃ­tÃ©sekor: ', updateError);
                        res.status(500).json({ message: 'Hiba tÃ¶rtÃ©nt a profil frissÃ­tÃ©se sorÃ¡n!' });
                    } else {
                        console.log('Profil frissÃ­tve');
                        res.status(200).json({ message: 'Profil sikeresen frissÃ­tve!' });
                    }
                });
            } else {
                // Az e-mail cÃ­m nem lÃ©tezik, Ãºj profil lÃ©trehozÃ¡sa
                const insertQuery = 'INSERT INTO profiles (searchValueRefrigerator, searchValueFreezer, searchValueHot_plate, searchValueMicrowave, searchValueDishwasher, searchValueDehumidifier, searchValueOven, searchValueWashing_machine, searchValueDryer, email) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)';
                const insertValues = [
                    searchValueRefrigerator, searchValueFreezer, searchValueHot_plate, searchValueMicrowave, searchValueDishwasher,
                    searchValueDehumidifier, searchValueOven, searchValueWashing_machine, searchValueDryer, email
                ];
                db.query(insertQuery, insertValues, (insertError, insertResult) => {
                    if (insertError) {
                        console.error('Hiba az adatbÃ¡zisba valÃ³ beszÃºrÃ¡s sorÃ¡n: ', insertError);
                        res.status(500).json({ message: 'Hiba tÃ¶rtÃ©nt a mentÃ©s sorÃ¡n!' });
                    } else {
                        console.log('Sikeres mentÃ©s');
                        res.status(200).json({ message: 'Sikeres mentÃ©s!' });
                    }
                });
            }
        }
    });
});


app.get('/profiles/:userEmail', function (req, res, next) {
    var adr = req.params.userEmail;
    var sql = 'SELECT * FROM profiles WHERE email = ?';
    db.query(sql, [adr], function (error, results) {
        if (error) {
            console.log(error);
            res.status(500).json({status: 'error'});
        } else {
            res.status(200).json(results);
        }
    });
});



